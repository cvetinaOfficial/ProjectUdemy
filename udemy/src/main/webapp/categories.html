<!DOCTYPE html>
<html lang="en">

<head>
    <title>Udemy</title>

    <meta name="apple-mobile-web-app-capable" content="yes">

    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
        integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
        integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Inconsolata&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.3/toastr.min.css" />
    <link rel="stylesheet" href="assets/css/style.css" />
</head>

<body style="font-family: 'Inconsolata', monospace;">
	<div class="container-fluid bg-light" style="box-shadow: 0 2px 4px rgba(0,0,0,.08), 0 4px 12px rgba(0,0,0,.08);
    z-index: 1010;">
        <div class="row justify-content-start align-items-center mr-5 ml-5" style="min-height: 70px;">
            <div class="col-md-6 text-center">
                <nav class="nav">
                    <a class="navbar-brand" href="#" style="color: #000000a1 !important;">
                        <img src="assets/img/icons/udemy-1.svg" width="30" height="30" class="d-inline-block align-top"
                            alt="">
                        demy
                    </a>

                    <a class="nav-link" href="categories.html">Categories</a>
                </nav>
            </div>
            <div class="col-md-6 text-right">
                <button type="button" class="btn btn-outline-danger" id="logout">Logout</button>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row align-items-center mb-3 mt-3">
            <div class="col-md-8">
                <h1>All categories</h1>
            </div>
        </div>
        <div class="modal fade" id="add-category-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Add category</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="name">Category Name:</label>
                            <input type="text" class="form-control" id="name" 
                                placeholder="Enter category name">
                        </div>
                        <div class="form-group">
                            <label for="imagePath">Image path:</label>
                            <input type="text" class="form-control" id="imagePath"
                                placeholder="Enter image path:">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="save-changes">Save changes</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="update-category-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Update category</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="name">Category Name:</label>
                            <input type="text" class="form-control" id="updateName" 
                                placeholder="Enter category name">
                        </div>
                        <div class="form-group">
                            <label for="imagePath">Image path:</label>
                            <input type="text" class="form-control" id="updateImagePath"
                                placeholder="Enter image path:">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="update">Update</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-3 justify-content-end">
            <div class="col-md-6 text-right">
                <button class="btn btn-outline-danger" id="switch-layout">Switch to row layout</button>
                <button class="btn btn-outline-danger" data-toggle="modal" data-target="#add-category-modal"
                    id="add-category-btn">Add category</button>
            </div>
        </div>
        <div class="row mt-3" id="categories">
        </div>
    </div>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.3/toastr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.2/dist/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous">
    </script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous">
    </script>
    <script>
        $(document).ready(function () {
        	
        	async function initCourses(data) {
            	data.forEach(item => {
            		let list = document.getElementById("categories");
                    let col6 = document.createElement("div");
                    col6.className = "col-md-6 mb-2 flex-column";

                    let cardElement = document.createElement("div");
                    cardElement.className = "card";
                    let imgContainer = document.createElement("div");
                    imgContainer.className = "w-100 p-3";
                    let img = document.createElement("img");
                    img.setAttribute('src', item.imagePath);
                    img.className = "img-thumbnail";
                    imgContainer.appendChild(img);
                    let imageLink = document.createElement('a');
                    imageLink.addEventListener('click',async function(event){
                    	event.preventDefault();
                    	let value = item.id;
                    	openCoursesWithCategory(value);
                    });
                    imageLink.appendChild(imgContainer);
                    cardElement.appendChild(imageLink);

                    let cardBody = document.createElement("div");
                    cardBody.className = "card-body ml-3";
                    let name = document.createElement("h5");
                    name.className = "mt-2";
                    name.textContent = item.name;

                    let divContainerButtons = document.createElement("div");
                    divContainerButtons.className = "mt-3";
                    let editBtn = document.createElement("button");
                    editBtn.type = "button";
                    editBtn.className = "btn btn-danger mr-2";
                    editBtn.value = item.id;
                    editBtn.textContent = "Edit category";
                    editBtn.addEventListener('click',async function(event){
                    	event.preventDefault();
                    	getCategoryById($(this).val());
                    });
                    let deleteBtn = document.createElement("button");
                    deleteBtn.type = "button";
                    deleteBtn.className = "btn btn-danger";
                    deleteBtn.value = item.id;
                    deleteBtn.textContent = "Delete category";
                    deleteBtn.addEventListener("click",async function (event){
                    	event.preventDefault();
                    	await deleteCategoryById($(this).val());
                    });

                    divContainerButtons.appendChild(editBtn);
                    divContainerButtons.appendChild(deleteBtn);

                    cardBody.appendChild(name);
                    cardBody.appendChild(divContainerButtons);
                    cardElement.appendChild(cardBody);
                    col6.appendChild(cardElement);
                    list.appendChild(col6);
            	});
                
            }
        	
        	async function deleteCategoryById(categoryId){
        		$.ajax({
    	            url: "/category/delete",
    	            method : "DELETE",
    	            data: {
    	            	id: categoryId
    	            },
    		    	complete: function(data){
    		    		if(data.status == 200){
    		    			toastr.options.onHidden = function() 
							{ 
								window.location.reload();
							}
    		    			toastr.success("Successfully deleted category!");
    		    			
    		    		}
    		    		
    		    		if(data.status == 404){
    		    			toastr.error("No such category!");
    		    		}
    		    		},
    		    		fail: function(){
          					toastr.error("Error occured on attempt to delete category!");
    		    		}
    	            })};
        	
        	function getCategoryById(categoryId){
        		$.ajax({
    	            url: "category",
    	            method : "GET",
    	            data: {
    	            	id: categoryId
    	            },
    		    	complete: function(data){
    		    		if(data.responseJSON != null){
    		    			toastr.success("Successfully get category!");
    		    			openUpdateCategoryModal(data.responseJSON);
    		    		}
    		    		
    		    		if(data.status == 404){
    		    			toastr.error("No such category!");
    		    		}
    		    		},
    		    		fail: function(){
          					toastr.error("Error occured on attempt to delete category!");
    		    		}
    	            })};
    	            
    	            function openCoursesWithCategory(categoryId){
    	            	window.localStorage.setItem("categoryId", categoryId);
    	            	window.location.href = "courses.html";
    	            }
    	            
    	            function openUpdateCategoryModal(result){
    	            	$('#updateName').val(result.name);
    	            	$('#updateImagePath').val(result.imagePath);
    	            	$('#update').val(result.id);
    	            	
    	            	$('#update-category-modal').modal('show');
    	            	
    	            	$('#update').on('click',function(){
    	            		let updatedName = $('#updateName').val();
        	            	let updatedImagePath = $('#updateImagePath').val();
        	            	
        	            	$.ajax({
        	    	            url: "/category/update",
        	    	            method : "PUT",
        	    	            data: {
        	    	            	id: result.id,
        	    	            	imagePath: updatedImagePath,
        	    	            	name: updatedName
        	    	            },
        	    		    	complete: function(data){
        	    		    		if(data.status == 200){
        	    		    			toastr.options.onHidden = function() 
        								{ 
        	    		    				$('#update-category-modal').modal('hide');
        									window.location.reload();
        								}
        	    		    			toastr.success("Successfully updated category!");
        	    		    		}
        	    		    		
        	    		    		if(data.status == 404){
        	    		    			$('#update-category-modal').modal('hide');
        	    		    			toastr.error("No such category!");
        	    		    		}
        	    		    		},
        	    		    		fail: function(){
        	    		    			$('#update-category-modal').modal('hide');
        	          					toastr.error("Error occured on attempt to delete category!");
        	    		    		}
        	    	            })
    	            	});
    	            	
    	            }
        	
        	async function getAllCategories(){
        		return $.ajax({
        	            url: "/categories/all",
        	            type: "GET",
        		    	success: function(data){
        		    		if(data){
        						return data;
        		    		}
        		    		},
        		    		fail: function(){
              					toastr.error("Error occured on attempt to register user!");
        		    		}
        	            })};
        	         
        	  let loadGetCategories = async function(){
        		  let result = await getAllCategories();
        		  await initCourses(result);
        	  }
        	  
        	  loadGetCategories();
        	            
        	  
        	$('#save-changes').click(function(){
        		let imagePath = $('#imagePath').val();
        		let name = $('#name').val();
        		
        		$.ajax({
			            url: "/category/add",
			            type: "POST",
			            data: {
		                    imagePath: imagePath,
							name: name
			            },
				    	complete: function(data){
				    		if(data.status == 201){
				    			toastr.options.onHidden = function() 
								{ 
				    				$('#add-category-modal').modal('hide');
									window.location.reload();
								}
								toastr.success("Successfully added category!");
				    		}
				    		if(data.status == 409){
				    			toastr.options.onHidden = function() 
								{ 
				    				$('#add-category-modal').modal('hide');
								}
		        				toastr.error("There is already category with that name!");
							}
				    		},
				    		fail: function(){
				    			toastr.options.onHidden = function() 
								{ 
				    				$('#add-category-modal').modal('hide');
								}
		        				toastr.error("Error occured on attempt to add category!");
				    		}
			            })});
        	        

            	$('#logout').on('click', function(){
        			$.ajax({
        				url: "logout",
        				method: "POST",
        				complete : function(data){
        					if(data.status == 401){
        						alert("ERROR!");
        					}
        					
        					window.location.href = "login.html";
        					
        				}
        			})
        		});

            $('#add-category-btn').click(function () {
                $('#myModal').modal('show');
            });

            

            $("#switch-layout").on('click', function () {
                let layout = $('.card').css('flex-direction');
                if (layout === "column") {
                    $('.card').css('flex-direction', 'row');
                    $(this).text('Switch to column layout');
                } else {
                    $('.card').css('flex-direction', 'column');
                    $(this).text('Switch to row layout');
                }
            });
        });
    </script>
</body>

</html>